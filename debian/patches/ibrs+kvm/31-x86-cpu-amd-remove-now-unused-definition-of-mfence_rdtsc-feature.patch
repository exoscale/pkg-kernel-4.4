From: Tom Lendacky <thomas.lendacky@amd.com>
Date: Mon, 18 Dec 2017 14:47:53 +0100
Subject: x86/CPU/AMD: Remove now unused definition of MFENCE_RDTSC feature
Patch-mainline: submitted on 2018/1/9
References: bsc#1068032

With the switch to using LFENCE_RDTSC on AMD platforms there is no longer
a need for the MFENCE_RDTSC feature.  Remove its usage and definition.

Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
Signed-off-by: Borislav Petkov <bp@suse.de>
---
 arch/x86/include/asm/barrier.h    | 3 +--
 arch/x86/include/asm/cpufeature.h | 2 +-
 arch/x86/include/asm/msr.h        | 3 +--
 3 files changed, 3 insertions(+), 5 deletions(-)

Index: kernel/arch/x86/include/asm/msr.h
===================================================================
--- kernel.orig/arch/x86/include/asm/msr.h
+++ kernel/arch/x86/include/asm/msr.h
@@ -147,8 +147,7 @@ static __always_inline unsigned long lon
 	 * that some other imaginary CPU is updating continuously with a
 	 * time stamp.
 	 */
-	alternative_2("", "mfence", X86_FEATURE_MFENCE_RDTSC,
-			  "lfence", X86_FEATURE_LFENCE_RDTSC);
+	alternative("", "lfence", X86_FEATURE_LFENCE_RDTSC);
 	return rdtsc();
 }
 
Index: kernel/arch/x86/include/asm/cpufeatures.h
===================================================================
--- kernel.orig/arch/x86/include/asm/cpufeatures.h
+++ kernel/arch/x86/include/asm/cpufeatures.h
@@ -92,7 +92,7 @@
 #define X86_FEATURE_SYSCALL32	( 3*32+14) /* "" syscall in ia32 userspace */
 #define X86_FEATURE_SYSENTER32	( 3*32+15) /* "" sysenter in ia32 userspace */
 #define X86_FEATURE_REP_GOOD	( 3*32+16) /* rep microcode works well */
-#define X86_FEATURE_MFENCE_RDTSC ( 3*32+17) /* "" Mfence synchronizes RDTSC */
+/* free, was #define X86_FEATURE_MFENCE_RDTSC ( 3*32+17) * "" Mfence synchronizes RDTSC */
 #define X86_FEATURE_LFENCE_RDTSC ( 3*32+18) /* "" Lfence synchronizes RDTSC */
 /* free, was #define X86_FEATURE_11AP	( 3*32+19) * "" Bad local APIC aka 11AP */
 #define X86_FEATURE_NOPL	( 3*32+20) /* The NOPL (0F 1F) instructions */
